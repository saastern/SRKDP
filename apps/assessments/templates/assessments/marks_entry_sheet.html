<!DOCTYPE html>
<html>
<head>
    <title>Marks Entry Sheet</title>
    <style>
        .marks-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        .marks-table th, .marks-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .marks-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .student-name {
            background-color: #f9f9f9;
            font-weight: bold;
            text-align: left;
        }
        .marks-input {
            width: 60px;
            text-align: center;
            border: none;
            background: transparent;
        }
        .calculated {
            background-color: #e6f3ff;
            font-weight: bold;
        }
        .controls {
            margin: 20px 0;
        }
        .controls select, .controls button {
            padding: 8px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>📊 Marks Entry Sheet</h1>
    
    <div class="controls">
        <select id="classSelect">
            <option value="">Select Class</option>
            {% for class in classes %}
                <option value="{{ class.id }}">{{ class.name }}</option>
            {% endfor %}
        </select>
        
        <select id="examSelect">
            <option value="">Select Exam</option>
            {% for exam in exams %}
                <option value="{{ exam.id }}">{{ exam.name }}</option>
            {% endfor %}
        </select>
        
        <button onclick="loadMarksSheet()">Load Sheet</button>
        <button onclick="calculateTotals()" style="background: blue; color: white;">Calculate Totals</button>
        <button onclick="saveMarks()" style="background: green; color: white;">Save Marks</button>
    </div>
    
    <div id="marksSheet"></div>
    
    <script>
        let currentData = null;
        
        function loadMarksSheet() {
            const classId = document.getElementById('classSelect').value;
            const examId = document.getElementById('examSelect').value;
            
            if (!classId || !examId) {
                alert('Please select both class and exam');
                return;
            }
            
            fetch('/assessments/marks-sheet-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    class_id: classId,
                    exam_id: examId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('DEBUG: Received data:', data);
                if (data.success) {
                    currentData = data;
                    renderMarksSheet(data);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching marks sheet data:', error);
                alert('An error occurred while loading the marks sheet.');
            });
        }
        
        function renderMarksSheet(data) {
            console.log('DEBUG: Starting renderMarksSheet');
            console.log('DEBUG: Data subjects:', data.subjects);
            console.log('DEBUG: Data students:', data.students);
            console.log('DEBUG: Max marks:', data.max_marks);
            
            let html = '<table class="marks-table">';
            
            // Header row
            html += '<tr><th>Roll No.</th><th>Student Name</th>';
            data.subjects.forEach(subject => {
                html += `<th>${subject.name}${subject.is_main ? '' : ' (Opt)'}</th>`;
            });
            html += '<th class="calculated">Total</th><th class="calculated">%</th><th class="calculated">Grade</th></tr>';
            
            // Student rows
            data.students.forEach(student => {
                html += `<tr data-student-id="${student.id}">`;
                html += `<td>${student.roll_number}</td>`;
                html += `<td class="student-name">${student.name}</td>`;
                
                data.subjects.forEach(subject => {
                    const existingMark = data.existing_marks[student.id]?.[subject.id];
                    const value = existingMark ? existingMark.marks : '';
                    
                    html += `<td>
                        <input type="number" 
                               class="marks-input" 
                               data-student-id="${student.id}" 
                               data-subject-id="${subject.id}"
                               value="${value}"
                               min="0" 
                               max="${data.max_marks}">
                    </td>`;
                });
                
                html += '<td class="calculated" id="total-' + student.id + '">-</td>';
                html += '<td class="calculated" id="percent-' + student.id + '">-</td>';
                html += '<td class="calculated" id="grade-' + student.id + '">-</td>';
                html += '</tr>';
            });
            
            html += '</table>';
            document.getElementById('marksSheet').innerHTML = html;
            
            // Add event listeners for auto-calculation with debouncing
            setTimeout(() => {
                const inputs = document.querySelectorAll('.marks-input');
                inputs.forEach(input => {
                    input.addEventListener('input', function() {
                        clearTimeout(window.calculateTimeout);
                        window.calculateTimeout = setTimeout(() => {
                            calculateTotals();
                        }, 300); // Wait 300ms after user stops typing
                    });
                });
            }, 100);
            
            calculateTotals();
        }
        
        function calculateTotals() {
            if (!currentData) return;
            
            console.log('DEBUG: Starting calculateTotals');
            console.log('DEBUG: Max marks per subject:', currentData.max_marks);
            
            currentData.students.forEach(student => {
                let total = 0;
                let subjectCount = 0;
                
                currentData.subjects.forEach(subject => {
                    if (subject.is_main) {
                        const input = document.querySelector(`input[data-student-id="${student.id}"][data-subject-id="${subject.id}"]`);
                        if (input) {
                            const value = parseFloat(input.value) || 0;
                            total += value;
                            subjectCount++;
                        }
                    }
                });
                
                const maxTotal = subjectCount * currentData.max_marks;
                const percentage = maxTotal > 0 ? (total / maxTotal * 100).toFixed(1) : 0;
                
                // Calculate grade
                let grade = 'E';
                if (percentage >= 91) grade = 'A1';
                else if (percentage >= 81) grade = 'A2';
                else if (percentage >= 71) grade = 'B1';
                else if (percentage >= 61) grade = 'B2';
                else if (percentage >= 51) grade = 'C1';
                else if (percentage >= 41) grade = 'C2';
                else if (percentage >= 33) grade = 'D';
                
                const totalEl = document.getElementById('total-' + student.id);
                const percentEl = document.getElementById('percent-' + student.id);
                const gradeEl = document.getElementById('grade-' + student.id);
                
                if (totalEl) totalEl.textContent = total;
                if (percentEl) percentEl.textContent = percentage + '%';
                if (gradeEl) gradeEl.textContent = grade;
            });
        }
        
        function saveMarks() {
            if (!currentData) {
                alert('Please load marks sheet first');
                return;
            }
            
            const marks = {};
            let totalMarksEntered = 0;
            
            currentData.students.forEach(student => {
                marks[student.id] = {};
                
                currentData.subjects.forEach(subject => {
                    const input = document.querySelector(`input[data-student-id="${student.id}"][data-subject-id="${subject.id}"]`);
                    
                    if (input) {
                        const value = parseFloat(input.value) || 0;
                        
                        if (value > 0) {
                            marks[student.id][subject.id] = {
                                marks: value,
                                is_absent: false
                            };
                            totalMarksEntered++;
                        }
                    }
                });
            });
            
            if (totalMarksEntered === 0) {
                alert('Please enter some marks before saving');
                return;
            }
            
            console.log('DEBUG: Saving marks:', marks);
            
            fetch('/assessments/save-marks-sheet/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    exam_id: document.getElementById('examSelect').value,
                    marks: marks
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('DEBUG: Save response:', data);
                if (data.success) {
                    alert('✅ Marks saved successfully!');
                } else {
                    alert('❌ Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error saving marks:', error);
                alert('An error occurred while saving marks: ' + error.message);
            });
        }
    </script>
</body>
</html>
